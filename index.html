<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Self-Touch Recording</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    #container {
      display: inline-block;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      max-width: 850px;
    }
    #videoWrapper {
      position: relative;
      display: inline-block;
    }
    video {
      border: 2px solid #ccc;
      border-radius: 4px;
      background: black;
      width: 480px;
      height: 640px;
      object-fit: cover;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 480px;
      height: 640px;
      pointer-events: none;
    }
    /* Simple torso+thighs silhouette: white dashed outline, transparent fill */
    #silhouette {
      position: absolute;
      left: 50%;
      top: 6%;
      transform: translateX(-50%);
      width: 65%;
      height: 84%;
      box-sizing: border-box;
      border-radius: 35% 35% 20% 20%;
      border: 4px dashed rgba(255,255,255,0.95);
    }
    /* Suggest shoulders/neck by narrowing top using inner line */
    #silhouette::before {
      content: "";
      position: absolute;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
      width: 55%;
      height: 18%;
      border-bottom: 4px dashed rgba(255,255,255,0.9);
      border-radius: 0 0 50% 50%;
      box-sizing: border-box;
    }
    /* Suggest hip line */
    #silhouette::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 55%;
      transform: translateX(-50%);
      width: 70%;
      border-top: 3px dashed rgba(255,255,255,0.85);
      box-sizing: border-box;
    }
    #overlayText {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      color: white;
      font-weight: bold;
      text-shadow: 0 0 5px black;
      font-size: 14px;
    }
    #startBtn, #downloadBtn {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #startBtn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #timer {
      margin-top: 10px;
      font-weight: bold;
    }
    #status {
      margin-top: 10px;
      font-size: 14px;
      color: #333;
      min-height: 20px;
    }
  </style>
</head>
<body>

  <div id="container">
    <h2>Self-Touch Activity Recording</h2>
    <p>
      Please position yourself so that your <strong>full torso, hips, and thighs</strong> are visible<br>
      inside the white dashed outline below.<br>
      Your <strong>face should stay out of the frame</strong> during the entire recording.
    </p>

    <div id="videoWrapper">
      <video id="preview" autoplay muted playsinline></video>
      <div id="overlay">
        <div id="silhouette"></div>
        <div id="overlayText">
          Align your body with the dashed outline.<br>
          Torso + thighs inside, face outside the frame.
        </div>
      </div>
    </div>

    <div id="timer">Time remaining: 00:20</div>
    <button id="startBtn">Start 20-second Recording</button>
    <button id="downloadBtn" style="display:none;">Download Video</button>
    <div id="status"></div>

    <p style="margin-top:15px; font-size:14px;">
      After you download the video, return to the survey and upload it in the next question.
    </p>
  </div>

  <script>
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const timerEl = document.getElementById('timer');
    const statusEl = document.getElementById('status');

    let mediaRecorder = null;
    let recordedChunks = [];
    let countdownInterval = null;
    let stream = null;

    // Get participant ID from URL (?pid=...)
    const params = new URLSearchParams(window.location.search);
    const participantId = params.get('pid') || 'participant';

    function updateTimer(seconds) {
      const m = String(Math.floor(seconds / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      timerEl.textContent = `Time remaining: ${m}:${s}`;
    }

    function startCountdown(seconds) {
      let remaining = seconds;
      updateTimer(remaining);
      countdownInterval = setInterval(() => {
        remaining--;
        updateTimer(remaining);
        if (remaining <= 0) {
          clearInterval(countdownInterval);
          stopRecording();
        }
      }, 1000);
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        statusEl.textContent = "Processing video...";
      }
      startBtn.disabled = false; // allow re-record if you want later
    }

    async function initAndStartRecording() {
      try {
        statusEl.textContent = "Requesting camera access...";
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          statusEl.textContent = "Camera not supported in this browser. Please try a different browser or device.";
          return;
        }

        // If we don't already have a stream, request it
        if (!stream) {
          stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          preview.srcObject = stream;
        }

        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const url = URL.createObjectURL(blob);

          downloadBtn.style.display = "inline-block";
          downloadBtn.onclick = () => {
            const now = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `${participantId}_selftouch_${now}.webm`;
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          };

          statusEl.textContent = "Recording complete. Download the video, then return to the survey and upload it.";
        };

        // Start recording
        mediaRecorder.start();
        statusEl.textContent = "Recording started. Please perform the self-touch activity for the full 20 seconds.";
        startBtn.disabled = true;
        startCountdown(20); // 20 seconds

      } catch (err) {
        console.error(err);
        if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
          statusEl.textContent = "Camera access was denied. Please allow camera permissions for this site in your browser settings and reload the page.";
        } else if (err.name === "NotFoundError" || err.name === "OverconstrainedError") {
          statusEl.textContent = "No suitable camera was found. Please check your webcam and try again.";
        } else {
          statusEl.textContent = "An error occurred while trying to access your camera. Please refresh the page or try a different browser.";
        }
      }
    }

    startBtn.addEventListener('click', () => {
      initAndStartRecording();
    });
  </script>
</body>
</html>
